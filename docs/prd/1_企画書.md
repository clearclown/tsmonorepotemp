# Nx + pnpm モノレポ構築 失敗記録

## 1. 初期構築段階の失敗

### 1.1 `--workspace-root` エラー

* **症状**

  ```
  pnpm add -D -w nx @nx/workspace ...
  ERROR — --workspace-root may only be used inside a workspace
  ```
* **原因**
  `pnpm init` 直後は `pnpm-workspace.yaml` が存在しないため、pnpm は「ワークスペースモード」と認識せず。
* **対策**
  先に `pnpm-workspace.yaml` を作成し、ルートで実行する。

---

## 2. オフラインモード関連の失敗

### 2.1 `ERR_PNPM_NO_OFFLINE_TARBALL`

* **症状**

  ```
  A package is missing from the store but cannot download it in offline mode.
  ```
* **原因**
  オフライン化 (`pnpm config set offline true`) した状態で `nx g` 実行時、未キャッシュの依存が必要になり失敗。
* **対策**
  オフライン化は**依存がすべてインストールされた後**に行う。生成直後は必ずオンラインで1回 `pnpm install` して lockfile を確定させる。

---

## 3. ディレクトリ構成ミス

### 3.1 パス指定間違い

* **症状**

  ```
  zsh: そのようなファイルやディレクトリはありません: apps/frontend/src/main.tsx
  ```
* **原因**
  Nx のデフォルト構造では `frontend/` が `apps/` 配下ではなくルート直下に生成されたため、コマンドが不一致。
* **対策**
  Nx 生成時の `directory` オプション確認、または `nx.json` の `workspaceLayout` を意図通りに設定。

---

## 4. `nx serve` 実行時の失敗

### 4.1 プロジェクト名不一致

* **症状**

  ```
  NX   Cannot find project 'frontend'
  ```
* **原因**
  実際の `project.json` の `"name"` と実行コマンドの引数が不一致。
* **対策**
  `pnpm nx show projects` または `cat <dir>/project.json | grep "name"` で実名確認してから実行。

---

## 5. Vite 実行時の失敗

### 5.1 `EMFILE: too many open files`

* **症状**

  ```
  Error: EMFILE: too many open files, watch ...
  ```
* **原因**
  Linux の `inotify` ファイル監視上限に到達。
* **対策**
  一時対策: Vite の `server.watch.usePolling` を有効化
  恒久対策: `/etc/sysctl.conf` に `fs.inotify.max_user_watches` を増やす設定。

---

## 6. NestJS 実行時の失敗

### 6.1 `EADDRINUSE: address already in use :::3000`

* **症状**

  ```
  Error: listen EADDRINUSE: address already in use :::3000
  ```
* **原因**
  ポート3000が既に他プロセスで使用中（別の `nx serve backend` が残っている）。
* **対策**

  * `lsof -i :3000` でPID確認後 `kill`
  * 開発環境ではポートを `.env` に設定可能にして衝突回避。

---

## 7. 構成面での想定外

* **Prettier 残留**
  Biome 統一予定にも関わらず Nx がデフォルトで `.prettierrc` を生成。
* **不要な E2E プロジェクト生成**
  `backend-e2e`（Jest）が不要だったが自動生成されサイズ増加。
* **共有ライブラリ未作成**
  `shared/` や Orval の生成を忘れ、フロント・バック間の型共有ができていない。
* **Better Auth 未組み込み**
  バックエンドの認証ルートがまだ空。

---

## 8. 再発防止ガイドライン

1. **初期化手順固定化**

   * `pnpm init` → `pnpm-workspace.yaml` 作成 → 依存インストール
2. **オフライン化のタイミング厳守**

   * 生成と初期 `install` 後にのみ設定
3. **プロジェクト名を必ず確認**

   * `pnpm nx show projects` で一致させる
4. **Vite の監視制限対策を最初に導入**
5. **ポート競合チェックの習慣化**
6. **不要な生成物を抑制**

   * `--unitTestRunner=none` などを正確指定
7. **設定ファイルの方針統一**

   * Biome / Prettier の二重管理を避ける
